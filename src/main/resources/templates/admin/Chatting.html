<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Learnovation : ì±„íŒ…ìƒë‹´</title>
  <!--css & js-->
  <link rel="stylesheet" href="/admin/css/Chatting.css">
  <!-- jQUery -->
  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <!-- í°íŠ¸ì–´ì¸ -->
  <script src="https://kit.fontawesome.com/f5db63554f.js" crossorigin="anonymous"></script>
</head>
<body>
<div class="side-nav">
  <header>LEARNOVATION</header>
  <ul>
    <a href="/admin/userList" class="active">
      <li class="nav-li">
        <span class="menu">ğŸ™‹â€â™‚ï¸ íšŒì›ê´€ë¦¬</span>
      </li>
    </a>
    <a href="#">
      <li class="nav-li">
        <span class="menu">ğŸ“š ê²Œì‹œíŒ ê´€ë¦¬</span>
      </li>
    </a>
    <a href="#">
      <li class="nav-li">
        <span class="menu">ğŸ“¢ ì‹ ê³  ê´€ë¦¬</span>
      </li>
    </a>
    <a href="/admin/course/register">
      <li class="nav-li">
        <span class="menu">ğŸ“º ê°•ì˜ ë“±ë¡</span>
      </li>
    </a>
    <a href="/admin/chatting">
      <li class="nav-li">
        <span class="menu">ğŸ“ ì±„íŒ… ìƒë‹´</span>
      </li>
    </a>
  </ul>
</div>
<div class="main">
  <h2>ğŸ“ ì±„íŒ… ìƒë‹´</h2>
  <div class="header-box">
    <div class="button-box">
      <button onclick="startChatting()" class="strat-chatting-btn">ìƒë‹´ ì‹œì‘í•˜ê¸°</button>
      <button onclick="closeChatting()" class="close-chatting-btn">ìƒë‹´ ì¢…ë£Œí•˜ê¸°</button>
    </div>
    <div class="notice-box">
      <h2>ğŸ’¥ì£¼ì˜ì‚¬í•­ğŸ’¥</h2>
      <h4>1. ì—…ë¬´ì‹œê°„ì€ 09ì‹œë¶€í„° 18ì‹œê¹Œì§€ì…ë‹ˆë‹¤. (ì ì‹¬ì€ 13ì‹œë¶€í„° 14ì‹œê¹Œì§€ì…ë‹ˆë‹¤.)</h4>
      <h4>2. ìƒˆë¡œê³ ì¹¨ì„ í•˜ê±°ë‚˜ í˜ì´ì§€ ì´ë™ ì‹œ í†µì‹ ì´ ì¢…ë£Œë©ë‹ˆë‹¤.</h4>
      <h4 th:style="'color: red'">&nbsp&nbsp- í‚¤ì…ë ¥ì„ í†µí•œ ìƒˆë¡œê³ ì¹¨ ì´ë²¤íŠ¸ë¥¼ ì œí•œí–ˆìœ¼ë¯€ë¡œ ê°•ì œë¡œ ì‹œë„í•˜ì§€ ë§ˆì„¸ìš”.</h4>
      <h4>&nbsp&nbsp- í˜ì´ì§€ê°€ ì´ë™ë˜ì§€ ì•Šë„ë¡ ì¡°ì‹¬í•˜ì„¸ìš”.</h4>
      <h4>3. ìƒë‹´ ì¢…ë£Œ ì‹œ ì„¸ì…˜ì´ ì†Œë©¸ë©ë‹ˆë‹¤. ë”°ë¼ì„œ ì´ì „ ìƒë‹´ë‚´ì—­ì„ í™•ì¸í•˜ê¸° ìœ„í•´ì„œëŠ” ê°œë°œíŒ€ì— ë¬¸ì˜í•˜ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</h4>
    </div>
  </div>
  <div class="chatting-box">
    <div class="client-list-box-initial">
      <h4>ìƒë‹´ ìš”ì²­ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</h4>
    </div>
    <div class="client-list-box">
    </div>
      <div class="message-box-initial">
        <img class="mesage-box-initial-img" th:src="@{/common/image/logo.png}" alt="">
        <h2>LEARNOVATION</h2>
      </div>
    <div class="message-box">
    </div>
  </div>
  <textarea class="input-box"></textarea>
</div>
</body>

<script>
  let startChatting = ()=>{
    document.querySelector('.strat-chatting-btn').innerHTML = "ìƒë‹´ ì¤‘";
    // Web Socket ì—°ê²° (ì±—ë´‡)
    const websocket = new WebSocket("ws://localhost:9999/ws/chatbot");
    websocket.onmessage = onMessage; // ì†Œì¼“ì´ ë©”ì‹œì§€ë¥¼ ë°›ì„ ë•Œ
    websocket.onopen = onOpen;      // ì†Œì¼“ì´ ìƒì„±ë  ë•Œ (í´ë¼ì´ì–¸íŠ¸ ì ‘ì†)
    websocket.onclose = onClose;    // ì†Œì¼“ì´ ë‹«í ë•Œ (í´ë¼ì´ì–¸íŠ¸ ì ‘ì† í•´ì œ)

    // í˜„ì¬ ì‚¬ìš©ì ì •ë³´
    let type = "ADMIN";
    let sessionId = null;
    const userId = "53"; //Client ë©”ì‹œì§€ë¥¼ ì „ë¶€ ë‹¤ dataset ì†ì„±ìœ¼ë¡œ ì¸í•´ ë¬¸ìì—´ë¡œ ì „ì†¡ë˜ë¯€ë¡œ ì–˜ë„ ê·¸ë ‡ê²Œ ë§ì¶¤ ì„œë²„ì—ì„œ parseLong í•´ì¤„ ê²ƒ

    function send(sessionId){ // ë©”ì‹œì§€ ì „ì†¡ ê¸°ëŠ¥
      let message = document.querySelector(".input-box").value;
      let toSendMessage = JSON.stringify({
        'type' : type,
        'sessionId' : sessionId,
        'senderId' : "53",
        'message' : message
      });
      websocket.send(toSendMessage);
    }
    function onOpen(event){ // ì—°ê²° ì‹œ
      let msg = JSON.stringify({
          'type' : type,
      });
      websocket.send(msg);
      console.log("ì±—ë´‡ ì„œë²„ì— ê´€ë¦¬ì ì—°ê²° ì™„ë£Œ");
    }
    function onClose(event){ // ì—°ê²°í•´ì œ ì‹œ
      // let msg = JSON.stringify({
      //     'type' : 'ENTER',
      //     'sessionId' : sessionId,
      //     'senderId' : userId,
      //     'message' : 'ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.'
      // });
      console.log("ì±—ë´‡ ì„œë²„ì™€ì˜ ì—°ê²° ì¢…ë£Œ");
    }
    function onMessage(msg){
      let rowMsg = msg.data;
      let jsonMsg = JSON.parse(rowMsg);

      // ê´€ë¦¬ì ì†Œì¼“ ì—°ê²° ì„±ê³µ ì‹œ typeì„ ADMIN_MSGë¡œ ë³€ê²½
      if(jsonMsg.type == "SUCCESS"){
        type = "ADMIN_MSG";
        alert("[ê´€ë¦¬ì] ìƒë‹´ì„ ì‹œì‘í•©ë‹ˆë‹¤.");
        console.log(jsonMsg);
      }

      // Clientê°€ ì—°ê²° ìš”ì²­í•œ ê²½ìš°
      if(jsonMsg.type == "CLIENT_ENTER"){
        document.querySelector('.client-list-box-initial').style.display = "none";
        document.querySelector('.client-list-box').style.display = "flex";
        // ì¢…ë£Œ í›„ ì¬ìš”ì²­ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ì¢Œì¸¡ ë©”ë‰´ ë™ê¸°í™” í•„ìš”
        let today = new Date();
        let time = today.toLocaleString();
        let tag = `<div id="` + jsonMsg.sessionId + `"class="client" onclick="showChatting(this)">
                      <div class="client-left">
                        <i class="fa-solid fa-user client-img" style="color: #000000;"></i>
                      </div>
                      <div class="client-middle">
                        <h3>${jsonMsg.name}</h3>
                        <h4><span class="client-list-box-alert-msg">(ìˆ˜ì‹ ë¨)</span> ${jsonMsg.message}</h4>
                      </div>
                      <div class="client-right">
                        <p>${time}</p>
                        <p>1ê°œ</p>
                      </div>
                  </div>`;
        if($(`#${jsonMsg.sessionId}`) != null){
          $(`#${jsonMsg.sessionId}`).remove();
          $('.client-list-box').prepend(tag);
        } else{
          $('.client-list-box').prepend(tag);
        }
      }

      // Clientê°€ ì „ì†¡í•œ ë©”ì‹œì§€
      if(jsonMsg.type == "CLIENT_MSG"){
        if($(`#${jsonMsg.sessionId}`) != null){
          $(`#${jsonMsg.sessionId}`).remove();
          let today = new Date();
          let time = today.toLocaleString();
          let tag = `<div id="` + jsonMsg.sessionId + `"class="client" onclick="showChatting(this)">
                      <div class="client-left">
                        <i class="fa-solid fa-user client-img" style="color: #000000;"></i>
                      </div>
                      <div class="client-middle">
                        <h3>${jsonMsg.name}</h3>
                        <h4><span class="client-list-box-alert-msg">(ìˆ˜ì‹ ë¨)</span> ${jsonMsg.message}</h4>
                      </div>
                      <div class="client-right">
                        <p>${time}</p>
                      </div>
                  </div>`;
          $('.client-list-box').prepend(tag);
        }
        if ($(".user-info") != null){
          let userInfoTag = document.querySelector(".user-info");
          let sessionId = userInfoTag.dataset.sessionId;
          if(jsonMsg.sessionId == sessionId){
            let date = new Date();
            let month = date.getMonth() + 1;
            let day = date.getDate();
            let hour = date.getHours();
            let minute = date.getMinutes();
            let formattedDate = `${month}ì›”${day}ì¼ ${hour}ì‹œ${minute}ë¶„`;
            let tag = `<div class="client-msg-box">
                        <div class="client-msg">
                          <p>${jsonMsg.message}</p>
                        </div>
                        <p class="client-msg-time">${formattedDate}</p>
                      </div>`;
            $(".message-box").append(tag);
          }
        }
      }

      // Clientì˜ ì—°ê²° ì¢…ë£Œ
      if (jsonMsg.type == "SOCKET_CLOSE"){
        if($(`#${jsonMsg.sessionId}`) != null){
          let today = new Date();
          let time = today.toLocaleString();
          let tag = $(`#${jsonMsg.sessionId}`);
          tag.find('.client-middle h4').text(`${jsonMsg.message}`);
          tag.find('client-right p').text(time);
          $(`#${jsonMsg.sessionId}`).remove();
          $('.client-list-box').prepend(tag);

        }
      }

      // Clientì˜ ì„¸ì…˜ì´ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²½ìš°
      if (jsonMsg.type == "CLOSED_SESSION"){
        alert(jsonMsg.message);
      }
    }

    document.querySelector(".input-box").addEventListener("keyup", (event)=>{
      let userInfoTag = document.querySelector(".user-info");
      let sessionId = userInfoTag.dataset.sessionId;
      let name = userInfoTag.dataset.name;
      if(event.keyCode == 13){
        if(!event.shiftKey){
          let date = new Date();
          let month = date.getMonth() + 1;
          let day = date.getDate();
          let hour = date.getHours();
          let minute = date.getMinutes();
          let formattedDate = `${month}ì›”${day}ì¼ ${hour}ì‹œ${minute}ë¶„`;
          let message = document.querySelector(".input-box").value;
          let tag = `<div class="admin-msg-box">
                            <div class="admin-msg">
                              <p>${message}</p>
                            </div>
                            <p class="admin-msg-time">${formattedDate}</p>
                          </div>`;
          $(".message-box").append(tag);
          send(sessionId);
          document.querySelector(".input-box").value = "";

          //ì™¼ìª½ ì±„íŒ…ëª©ë¡ ë™ê¸°í™”
          if($(`#${sessionId}`) != null){
            $(`#${sessionId}`).remove();
            let today = new Date();
            let time = today.toLocaleString();
            let tag = `<div id="` + sessionId + `"class="client" onclick="showChatting(this)">
                      <div class="client-left">
                        <i class="fa-solid fa-user client-img" style="color: #000000;"></i>
                      </div>
                      <div class="client-middle">
                        <h3>${name}</h3>
                        <h4><span class="client-list-box-alert-msg2">(ì „ì†¡ë¨)</span> ${message}</h4>
                      </div>
                      <div class="client-right">
                        <p>${time}</p>
                      </div>
                  </div>`;
            $('.client-list-box').prepend(tag);
          }
        }
      }
    });
  }

  let showChatting = (tag)=>{
    let sessionId = tag.id;
    document.querySelector('.message-box-initial').style.display = "none";
    document.querySelector(".message-box").style.display = "flex";
    document.querySelector(".input-box").style.display = "block";
    document.querySelector(".message-box").innerHTML = "";
    $.ajax({
      type : 'POST',
      url : '/admin/chatting/list',
      contentType : 'application/json',
      data : JSON.stringify({
        'sessionId': sessionId
      }),
      success : function(response){
        // ìœ ì € ì •ë³´ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€
        if(response[0].senderId == 0){
          let tag = `<div class="user-info" data-session-id="${sessionId}" data-name="ë¹„íšŒì›">
                        <h2>ë¹„íšŒì›</h2>
                      </div>`;
          $(".message-box").prepend(tag);
        } else{
          let tag = `<div class="user-info" data-session-id="${sessionId}" data-name="${response[0].user.name}">
                        <p><b>ì´ë¦„: </b>${response[0].user.name}</p>
                        <p><b>ì´ë©”ì¼: </b>${response[0].user.email}</p>
                        <p><b>ì—°ë½ì²˜: </b>${response[0].user.phoneNumber}</p>
                        <p><b>ê°€ì…ì¼: </b>${response[0].user.createdAt}</p>
                    </div>`;
          $(".message-box").prepend(tag);
        }

        // ì±„íŒ… ë‚´ì—­ ì¶”ê°€
        $(response).each(function(index, chatting){
          let date = new Date(chatting.createdAt);
          let month = date.getMonth() + 1;
          let day = date.getDate();
          let hour = date.getHours();
          let minute = date.getMinutes();
          let formattedDate = `${month}ì›”${day}ì¼ ${hour}ì‹œ${minute}ë¶„`;
          // Clientì¸ì§€ Adminì¸ì§€ êµ¬ë¶„í•˜ì—¬ ì±„íŒ…íƒœê·¸ ì¶”ê°€
          if(chatting.senderId != 53){
            let tag = `<div class="client-msg-box">
                          <div class="client-msg">
                            <p>${chatting.message}</p>
                          </div>
                          <p class="client-msg-time">${formattedDate}</p>
                        </div>`;
            $(".message-box").append(tag);
          } else{
            let tag = `<div class="admin-msg-box">
                          <div class="admin-msg">
                            <p>${chatting.message}</p>
                          </div>
                          <p class="admin-msg-time">${formattedDate}</p>
                        </div>`;
            $(".message-box").append(tag);
          }
          // Client ì†Œì¼“ ì¢…ë£Œ ê°ì§€ DB ì‚­ì œì—¬ë¶€
          if ((chatting.message).includes('CODE:SC9999')){
            let tag = `<div class="close-msg-box">
                          <div class="close-msg">
                              <p><b>[${sessionId}]</b> ì„¸ì…˜ì€ ì†Œë©¸ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                              <p>í•´ë‹¹ ëŒ€í™”ë¥¼ ë°±ì—…í• ê¹Œìš”?</p>
                          </div>
                          <div class="backup">
                              <button id="backup-btn" onclick="chattingBackup('${sessionId}')">ë°±ì—…</button>
                              <button id="delete-btn" onclick="chattingDelete('${sessionId}')">ì‚­ì œ</button>
                          </div>
                      </div>`;
            $(".message-box").append(tag);
          }
        });
      }
    });
  }

  let chattingBackup = (sessionId) =>{
    alert("DBì— ì •ìƒì ìœ¼ë¡œ ë°±ì—…ë˜ì—ˆìŠµë‹ˆë‹¤.");
  };

  let chattingDelete = (sessionId) =>{
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")){
      return false;
    }
    $.ajax({
      type : 'POST',
      url : '/admin/chatting/delete',
      contentType : 'application/json',
      data : JSON.stringify({
        'sessionId' : sessionId
      }),
      success : function(response){
        if(response == "success"){
          alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.")
          document.querySelector(".message-box").innerHTML = "";
          document.querySelector('.message-box-initial').style.display = "flex";
          document.querySelector(".message-box").style.display = "none";
          document.querySelector(".input-box").style.display = "none";
          $(`#${sessionId}`).remove();
        }
      }
    });
  }

  let closeChatting = ()=>{
    alert("ìƒë‹´ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
    location.reload();
  }
  //ìŠ¤í¬ë¡¤ ìë™ ë‚´ë¦¬ê¸°
  let scrollDown = () =>{
    let scrollDiv = document.querySelector(".chat-bot-modal-chatting");
    scrollDiv.scrollTop = scrollDiv.scrollHeight;
  }

  // ìƒˆë¡œê³ ì¹¨ ì œì–´
  function NotReload(){
    if( (event.ctrlKey == true && (event.keyCode == 78 || event.keyCode == 82)) || (event.keyCode == 116) ) {
      event.keyCode = 0;
      event.cancelBubble = true;
      event.returnValue = false;
    }
  }
  document.onkeydown = NotReload;
</script>
</html>